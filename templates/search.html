{% extends "index.html" %}

{% block content %}
<style>
    /* 검색 페이지 전용 스타일만 */
    .search-btn {
        background: linear-gradient(135deg, #667eea 0%, var(--primary-color) 100%);
        border: none;
        padding: 12px 40px;
        color: white;
        font-weight: bold;
        border-radius: 25px;
        transition: all 0.3s;
        height: fit-content;
        white-space: nowrap;
    }

    .search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px var(--shadow-hover);
    }

    .player-search-wrapper {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .player-name-input {
        flex: 1;
    }

    .season-controls {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .season-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 15px;
        background: var(--bg-secondary);
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .season-item {
        cursor: pointer;
        position: relative;
        display: inline-block;
    }

    .season-checkbox {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .season-img {
        width: 40px;
        height: 40px;
        object-fit: contain;
        border: 2px solid transparent;
        border-radius: 5px;
        padding: 2px;
        background: var(--bg-main);
        transition: all 0.3s;
        display: block;
    }

    .season-item.selected .season-img {
        border-color: var(--primary-color);
        background: var(--primary-light);
        transform: scale(1.1);
    }

    .season-item:hover .season-img {
        transform: scale(1.05);
        box-shadow: 0 2px 8px var(--shadow-main);
    }

    .position-filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        padding: 15px;
        background: var(--bg-secondary);
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .position-group {
        min-width: 200px;
    }

    .position-group-title {
        font-size: var(--fs-group);
        font-weight: bold;
        color: var(--text-dark);
        margin-bottom: 10px;
    }

    .position-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .position-item {
        display: inline-block;
        cursor: pointer;
    }

    .position-checkbox {
        display: none;
    }

    .position-btn {
        display: inline-block;
        padding: 8px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-main);
        color: var(--text-muted);
        font-weight: 500;
        font-size: 14px;
        transition: all 0.3s;
        min-width: 50px;
        text-align: center;
    }

    .position-checkbox:checked+.position-btn {
        background: var(--primary-color);
        color: var(--bg-main);
        border-color: var(--primary-color);
        transform: scale(1.05);
    }

    .position-item:hover .position-btn {
        border-color: var(--primary-color);
        transform: scale(1.02);
    }

    .season-count {
        background: var(--primary-color);
        color: var(--bg-main);
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.9em;
    }

    .detail-filter-section {
        padding: 20px;
        background: var(--bg-secondary);
        border-radius: 10px;
    }

    .filter-group {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
    }

    .filter-group:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .filter-group-title {
        font-size: var(--fs-group);
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 12px;
    }

    .range-inputs {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .range-inputs input {
        max-width: 120px;
    }

    .team-color-group {
        margin-bottom: 10px;
    }

    .body-type-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .body-type-item {
        display: inline-block;
    }

    .body-type-checkbox {
        display: none;
    }

    .body-type-label {
        padding: 6px 14px;
        border: 2px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        color: var(--text-primary);
        background: var(--bg-main);
    }

    .body-type-checkbox:checked+.body-type-label {
        background: var(--primary-color);
        color: var(--bg-main);
        border-color: var(--primary-color);
    }

    .trait-select {
        width: 100%;
        min-height: 100px;
    }

    .foot-select-group {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .foot-select-group>div {
        flex: 1;
    }

    .select2-container--bootstrap-5 .select2-selection {
        border: 1px solid #ced4da;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .select2-container--bootstrap-5.select2-container--focus .select2-selection,
    .select2-container--bootstrap-5.select2-container--open .select2-selection {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem var(--shadow-focus);
    }

    .select2-container--bootstrap-5 .select2-results__option--selected {
        background-color: var(--primary-color);
    }

    .select2-container--bootstrap-5 .select2-results__option--highlighted {
        background-color: var(--primary-light);
        color: var(--primary-color);
    }

    .section-title {
        font-size: var(--fs-section);
        font-weight: bold;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .label-title {
        font-size: var(--fs-label);
        font-weight: 500;
        color: var(--text-secondary);
    }

    /* 다크모드 대응 - 입력 필드 스타일 */
    .form-control,
    .form-select {
        background: var(--bg-main) !important;
        /* ← 박스보다 밝은 배경 */
        border: 1px solid var(--border-color) !important;
        color: var(--text-primary) !important;
    }

    .form-control::placeholder {
        color: var(--text-secondary) !important;
        opacity: 0.7;
    }

    .form-control:focus,
    .form-select:focus {
        background: var(--bg-main) !important;
        border-color: var(--primary-color) !important;
        color: var(--text-primary) !important;
        box-shadow: 0 0 0 0.25rem var(--shadow-focus) !important;
    }

    /* 셀렉트 옵션 다크모드 (주발/약발 드롭다운) */
    [data-theme="dark"] .form-select option {
        background: #1a202c !important;
        /* ← 어두운 배경 */
        color: #e2e8f0 !important;
    }

    [data-theme="light"] .form-select option {
        background: #ffffff !important;
        color: #1a202c !important;
    }

    /* Select2 다크모드 대응 */
    .select2-container--bootstrap-5 .select2-selection {
        background: var(--bg-main) !important;
        /* ← 밝은 배경 */
        border: 1px solid var(--border-color) !important;
        color: var(--text-primary) !important;
    }

    .select2-container--bootstrap-5 .select2-selection__rendered {
        color: var(--text-primary) !important;
    }

    .select2-container--bootstrap-5 .select2-selection__placeholder {
        color: var(--text-secondary) !important;
    }

    /* Select2 드롭다운 다크모드 (투명 문제 해결) */
    .select2-container--bootstrap-5 .select2-dropdown {
        background: #1a202c !important;
        /* ← 완전 불투명 */
        border: 1px solid var(--border-color) !important;
        z-index: 9999;
    }

    .select2-container--bootstrap-5 .select2-results__option {
        background: #1a202c !important;
        /* ← 각 옵션도 불투명 */
        color: #e2e8f0 !important;
        padding: 8px 12px;
    }

    .select2-container--bootstrap-5 .select2-results__option--highlighted {
        background: #667eea !important;
        /* ← 호버 시 파란색 */
        color: #ffffff !important;
    }

    .select2-container--bootstrap-5 .select2-results__option--selected {
        background: #4c51bf !important;
        /* ← 선택 시 진한 파란색 */
        color: #ffffff !important;
    }

    .select2-container--bootstrap-5 .select2-search__field {
        background: var(--bg-main) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-primary) !important;
    }

    /* Select2 검색창 다크모드 */
    .select2-container--bootstrap-5 .select2-search--dropdown {
        background: #1a202c !important;
        padding: 8px;
    }

    /* 라이트모드 Select2 드롭다운 */
    [data-theme="light"] .select2-dropdown {
        background: #ffffff !important;
    }

    [data-theme="light"] .select2-results__option {
        background: #ffffff !important;
        color: #1a202c !important;
    }

    [data-theme="light"] .select2-results__option--highlighted {
        background: #e6f2ff !important;
        color: #667eea !important;
    }

    /* 모바일 최적화 */
    @media (max-width: 768px) {

        /* 선수 이름 검색창 */
        .player-name-input input {
            padding: 8px 12px;
            font-size: 0.85rem;
            height: 36px;
        }

        /* 검색 버튼 */
        .search-btn {
            padding: 8px 20px;
            font-size: 0.85rem;
            height: 36px;
        }

        /* 검색창 래퍼 */
        .player-search-wrapper {
            gap: 8px;
        }

        /* 시즌 선택 섹션 */
        .season-selector {
            gap: 6px;
            padding: 12px;
        }

        /* 시즌 아이콘 크기 축소 */
        .season-img {
            width: 32px;
            height: 32px;
        }

        /* 시즌 컨트롤 버튼들 */
        .season-controls button {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* 포지션 필터 */
        .position-filter-container {
            gap: 15px;
            padding: 12px;
        }

        .position-group {
            min-width: 150px;
        }

        .position-group-title {
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .position-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* 세부 필터 섹션 */
        .form-label {
            font-size: 0.9rem;
        }

        .form-control,
        .form-select {
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        /* 특성 선택 */
        .trait-buttons {
            gap: 6px;
        }

        .trait-btn {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        /* 섹션 타이틀 */
        .section-title {
            font-size: 1.1rem;
            margin-bottom: 12px;
        }
    }
</style>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    rel="stylesheet" />

<!-- ❌ 제목 삭제 -->
<!-- ❌ 다크모드 버튼 삭제 -->

<form action="/results" method="GET" id="searchForm">
    <!-- 선수 이름 검색 + 검색 버튼 -->
    <div class="mb-4">
        <label class="form-label section-title">선수 이름</label>
        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
            <div class="player-search-wrapper">
                <div class="player-name-input" style="position: relative;">
                    <input type="text" class="form-control form-control-lg" name="player_name" id="playerNameInput"
                        placeholder="부분 검색 및 ','를 통한 복수 검색 가능" autocomplete="off">
                    <div id="autocompleteList"
                        style="position: absolute; z-index: 1000; display: none; background: var(--bg-main); border: 1px solid var(--border-color); border-radius: 8px; max-height: 300px; overflow-y: auto; width: calc(100% - 30px); margin-top: 5px; box-shadow: 0 4px 12px var(--shadow-main);">
                    </div>
                </div>
                <button type="submit" class="search-btn">검색</button>
            </div>
        </div>
    </div>

    <!-- 시즌 선택 -->
    <div class="mb-4">
        <label class="form-label section-title">시즌 선택</label>
        <div class="season-selector" id="seasonSelector">
            {% for season in seasons %}
            <div class="season-item" data-season-id="{{ season.season_id }}"
                data-season-name="{{ season.season_name }}">
                <input type="checkbox" name="seasons" value="{{ season.season_id }}" class="season-checkbox"
                    id="season_{{ season.season_id }}">
                <img src="{{ season.season_img_url }}" alt="{{ season.season_name }}" title="{{ season.season_name }}"
                    class="season-img">
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 포지션 선택 -->
    <div class="mb-4">
        <label class="form-label section-title">포지션 선택</label>
        <div class="position-filter-container">
            <div class="position-group">
                <div class="position-group-title">공격수</div>
                <div class="position-buttons">
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="ST" class="position-checkbox">
                        <span class="position-btn">ST</span>
                    </label>
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="CF" class="position-checkbox">
                        <span class="position-btn">CF</span>
                    </label>
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="RW" class="position-checkbox">
                        <span class="position-btn">RW</span>
                    </label>
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="LW" class="position-checkbox">
                        <span class="position-btn">LW</span>
                    </label>
                </div>
            </div>

            <div class="position-group">
                <div class="position-group-title">미드필더</div>
                <div class="position-buttons">
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="CAM" class="position-checkbox">
                        <span class="position-btn">CAM</span>
                    </label>
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="LM" class="position-checkbox">
                        <span class="position-btn">LM</span>
                    </label>
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="RM" class="position-checkbox">
                        <span class="position-btn">RM</span>
                    </label>
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="CM" class="position-checkbox">
                        <span class="position-btn">CM</span>
                    </label>
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="CDM" class="position-checkbox">
                        <span class="position-btn">CDM</span>
                    </label>
                </div>
            </div>

            <div class="position-group">
                <div class="position-group-title">수비수</div>
                <div class="position-buttons">
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="CB" class="position-checkbox">
                        <span class="position-btn">CB</span>
                    </label>
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="RB" class="position-checkbox">
                        <span class="position-btn">RB</span>
                    </label>
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="LB" class="position-checkbox">
                        <span class="position-btn">LB</span>
                    </label>
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="RWB" class="position-checkbox">
                        <span class="position-btn">RWB</span>
                    </label>
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="LWB" class="position-checkbox">
                        <span class="position-btn">LWB</span>
                    </label>
                </div>
            </div>

            <div class="position-group">
                <div class="position-group-title">골키퍼</div>
                <div class="position-buttons">
                    <label class="position-item">
                        <input type="checkbox" name="positions" value="GK" class="position-checkbox">
                        <span class="position-btn">GK</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- 상세 검색 조건 -->
    <div class="mb-4">
        <label class="form-label section-title">상세 검색 조건</label>
        <div class="detail-filter-section">

            <!-- 급여와 오버롤 -->
            <div class="filter-group">
                <div class="row">
                    <div class="col-md-6">
                        <div class="filter-group-title">급여</div>
                        <div class="range-inputs">
                            <input type="number" class="form-control" name="min_salary" placeholder="최소">
                            <span>~</span>
                            <input type="number" class="form-control" name="max_salary" placeholder="최대">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="filter-group-title">오버롤</div>
                        <div class="range-inputs">
                            <input type="number" class="form-control" name="min_ovr" min="0" max="150" placeholder="최소">
                            <span>~</span>
                            <input type="number" class="form-control" name="max_ovr" min="0" max="150" placeholder="최대">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 주발 & 약발 -->
            <div class="filter-group">
                <div class="filter-group-title">주발 & 약발</div>
                <div class="foot-select-group">
                    <div>
                        <label class="form-label label-title">주발</label>
                        <select class="form-select" name="preferred_foot">
                            <option value="">왼발 or 오른발</option>
                            <option value="left">왼발</option>
                            <option value="right">오른발</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label label-title">약발 (이상)</label>
                        <select class="form-select" name="weak_foot_min">
                            <option value="">1~5</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 신장과 몸무게 -->
            <div class="filter-group">
                <div class="row">
                    <div class="col-md-6">
                        <div class="filter-group-title">신장</div>
                        <div class="range-inputs">
                            <input type="number" class="form-control" name="min_height" placeholder="최소">
                            <span>~</span>
                            <input type="number" class="form-control" name="max_height" placeholder="최대">
                            <span>cm</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="filter-group-title">몸무게</div>
                        <div class="range-inputs">
                            <input type="number" class="form-control" name="min_weight" placeholder="최소">
                            <span>~</span>
                            <input type="number" class="form-control" name="max_weight" placeholder="최대">
                            <span>kg</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 팀컬러 선택 -->
            <div class="filter-group">
                <div class="filter-group-title">팀컬러 선택</div>
                <div class="team-color-group">
                    <label class="form-label label-title">국가 팀컬러</label>
                    <select class="form-select teamcolor-select" name="nation_team_color" data-placeholder="국가를 선택하세요">
                        <option value=""></option>
                        {% for nation in nation_teamcolors %}
                        <option value="{{ nation }}">{{ nation }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="team-color-group">
                    <label class="form-label label-title">소속 팀컬러 1</label>
                    <select class="form-select teamcolor-select" name="club_team_color_1" data-placeholder="클럽을 선택하세요">
                        <option value=""></option>
                        {% for club in club_teamcolors %}
                        <option value="{{ club }}">{{ club }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="team-color-group">
                    <label class="form-label label-title">소속 팀컬러 2</label>
                    <select class="form-select teamcolor-select" name="club_team_color_2" data-placeholder="클럽을 선택하세요">
                        <option value=""></option>
                        {% for club in club_teamcolors %}
                        <option value="{{ club }}">{{ club }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="team-color-group">
                    <label class="form-label label-title">특성 팀컬러</label>
                    <select class="form-select teamcolor-select" name="trait_team_color" data-placeholder="특성을 선택하세요">
                        <option value=""></option>
                        {% for trait in trait_teamcolors %}
                        <option value="{{ trait }}">{{ trait }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- 체형 -->
            <div class="filter-group">
                <div class="filter-group-title">체형</div>
                <div class="body-type-options">
                    <label class="body-type-item">
                        <input type="checkbox" name="body_types" value="마름" class="body-type-checkbox">
                        <span class="body-type-label">마름</span>
                    </label>
                    <label class="body-type-item">
                        <input type="checkbox" name="body_types" value="보통" class="body-type-checkbox">
                        <span class="body-type-label">보통</span>
                    </label>
                    <label class="body-type-item">
                        <input type="checkbox" name="body_types" value="건장" class="body-type-checkbox">
                        <span class="body-type-label">건장</span>
                    </label>
                    <label class="body-type-item">
                        <input type="checkbox" name="body_types" value="마름(고유)" class="body-type-checkbox">
                        <span class="body-type-label">마름(고유)</span>
                    </label>
                    <label class="body-type-item">
                        <input type="checkbox" name="body_types" value="보통(고유)" class="body-type-checkbox">
                        <span class="body-type-label">보통(고유)</span>
                    </label>
                    <label class="body-type-item">
                        <input type="checkbox" name="body_types" value="건장(고유)" class="body-type-checkbox">
                        <span class="body-type-label">건장(고유)</span>
                    </label>
                </div>
            </div>

            <!-- 보유 고유 특성 -->
            <div class="filter-group">
                <div class="filter-group-title">고유 특성</div>
                <div class="row g-2">
                    <div class="col-3">
                        <label class="form-label label-title">신규 특성</label>
                        <select class="form-select trait-select" name="new_trait" data-placeholder="신규 특성 선택">
                            <option value=""></option>
                            {% for trait in new_traits %}
                            <option value="{{ trait }}">{{ trait }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-3">
                        <label class="form-label label-title">일반 특성 1</label>
                        <select class="form-select trait-select" name="normal_trait_1" data-placeholder="일반 특성 선택">
                            <option value=""></option>
                            {% for trait in normal_traits %}
                            <option value="{{ trait }}">{{ trait }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-3">
                        <label class="form-label label-title">일반 특성 2</label>
                        <select class="form-select trait-select" name="normal_trait_2" data-placeholder="일반 특성 선택">
                            <option value=""></option>
                            {% for trait in normal_traits %}
                            <option value="{{ trait }}">{{ trait }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-3">
                        <label class="form-label label-title">일반 특성 3</label>
                        <select class="form-select trait-select" name="normal_trait_3" data-placeholder="일반 특성 선택">
                            <option value=""></option>
                            {% for trait in normal_traits %}
                            <option value="{{ trait }}">{{ trait }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 하단 검색 버튼 -->
        <div class="mt-5 text-center">
            <button type="submit" class="search-btn">검색</button>
        </div>
    </div>
</form>

<!-- jQuery & Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/ko.js"></script>

<script>
    // 시즌 선택 관리
    class SeasonManager {
        constructor() {
            this.seasonItems = document.querySelectorAll('.season-item');
            // selectAllCheckbox와 seasonCount 관련 코드 삭제

            this.init();
        }

        init() {
            // 페이지 로드 시 아무것도 선택하지 않음 (this.selectAll() 호출 제거)

            // 시즌 아이템 클릭 이벤트
            this.seasonItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.toggleSeason(item);
                });
            });

            // 전체 선택 체크박스 이벤트 삭제

            // 폼 제출 시 처리
            document.getElementById('searchForm').addEventListener('submit', (e) => {
                const selectedCount = document.querySelectorAll('.season-checkbox:checked').length;

                // 먼저 모든 체크박스의 name 속성 복구
                document.querySelectorAll('.season-checkbox').forEach(cb => {
                    if (!cb.hasAttribute('name')) {
                        cb.setAttribute('name', 'seasons');
                    }
                });

                // 시즌이 선택되지 않았을 때는 name 속성 제거 (전체 검색)
                if (selectedCount === 0) {
                    document.querySelectorAll('.season-checkbox').forEach(cb => {
                        cb.removeAttribute('name');
                    });
                }

                // 경고 메시지 제거 (시즌 선택 안 해도 검색 가능)
            });
        }

        toggleSeason(item) {
            const checkbox = item.querySelector('.season-checkbox');
            const isChecked = checkbox.checked;

            checkbox.checked = !isChecked;

            if (!isChecked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }

            // updateCount()와 updateSelectAllCheckbox() 호출 제거
        }

        selectAll() {
            this.seasonItems.forEach(item => {
                const checkbox = item.querySelector('.season-checkbox');
                checkbox.checked = true;
                item.classList.add('selected');
            });
            this.updateCount();
        }

        deselectAll() {
            this.seasonItems.forEach(item => {
                const checkbox = item.querySelector('.season-checkbox');
                checkbox.checked = false;
                item.classList.remove('selected');
            });
            this.updateCount();
        }
    }

    // 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', () => {
        new SeasonManager();

        // Select2 초기화 - 팀컬러 선택
        $('.teamcolor-select').select2({
            theme: 'bootstrap-5',
            language: 'ko',
            allowClear: true,
            width: '100%',
            minimumInputLength: 0,
            placeholder: function () {
                return $(this).data('placeholder');
            }
        });

        // Select2 초기화 - 고유 특성 선택
        $('.trait-select').select2({
            theme: 'bootstrap-5',
            language: 'ko',
            allowClear: true,
            width: '100%',
            minimumInputLength: 0,
            placeholder: function () {
                return $(this).data('placeholder');
            }
        });

        // 선수 이름 자동완성
        let playerNames = [];

        // 백그라운드에서 비동기로 로드
        fetch('/api/player_names')
            .then(response => response.json())
            .then(data => {
                playerNames = data;
                console.log('자동완성 데이터 로드 완료');
            })
            .catch(error => {
                console.error('자동완성 데이터 로드 실패:', error);
            });

        const input = document.getElementById('playerNameInput');
        const autocompleteList = document.getElementById('autocompleteList');

        if (input) {
            let currentFocus = -1; // 현재 포커스된 항목 인덱스

            // 키보드 이벤트 처리
            input.addEventListener('keydown', function (e) {
                const items = autocompleteList.getElementsByTagName('div');

                // 드롭박스가 보이지 않으면 키보드 네비게이션 비활성화
                if (autocompleteList.style.display === 'none') {
                    return; // 폼 제출은 정상 작동
                }

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus++;
                    if (currentFocus >= items.length) currentFocus = 0;
                    setActive(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus--;
                    if (currentFocus < 0) currentFocus = items.length - 1;
                    setActive(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentFocus > -1 && items[currentFocus]) {
                        items[currentFocus].click();
                    }
                }
            });

            function setActive(items) {
                if (!items) return;
                // 모든 항목 초기화
                for (let i = 0; i < items.length; i++) {
                    items[i].style.background = 'transparent';
                }
                // 현재 항목 하이라이트
                if (currentFocus >= 0 && currentFocus < items.length) {
                    items[currentFocus].style.background = 'var(--hover-bg)';
                }
            }

            input.addEventListener('input', function () {
                const value = this.value.trim();

                // 데이터 아직 안 로드되었으면 무시
                if (playerNames.length === 0) {
                    return;
                }

                // 2글자 미만이면 숨기기
                if (value.length < 2) {
                    autocompleteList.style.display = 'none';
                    return;
                }

                // 필터링
                const filtered = playerNames
                    .filter(player => player.name.includes(value))
                    .slice(0, 10);

                if (filtered.length === 0) {
                    autocompleteList.style.display = 'none';
                    return;
                }

                // 드롭다운 생성
                autocompleteList.innerHTML = filtered.map((player, index) =>
                    `<div class="autocomplete-item" data-index="${index}" style="padding: 10px 15px; cursor: pointer; color: var(--text-primary); transition: background 0.2s;" 
  onmouseover="currentFocus=${index}; setActive(this.parentElement.getElementsByTagName('div'))" 
  onmouseout="currentFocus=-1; this.style.background='transparent'"
  onclick="selectPlayer('${player.name}')">${player.name}</div>`
                ).join('');

                autocompleteList.style.display = 'block';
                currentFocus = 0; // 첫 항목 자동 선택
                const items = autocompleteList.getElementsByTagName('div');
                setActive(items);
            });
        }

        // selectPlayer 함수를 전역으로 이동
        window.selectPlayer = function (name) {
            const input = document.getElementById('playerNameInput');
            const autocompleteList = document.getElementById('autocompleteList');
            input.value = name;
            autocompleteList.style.display = 'none';
        };

        // 바깥 클릭 시 닫기
        document.addEventListener('click', function (e) {
            if (input && !input.contains(e.target) && !autocompleteList.contains(e.target)) {
                autocompleteList.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}