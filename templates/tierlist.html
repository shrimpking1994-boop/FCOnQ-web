{% extends "index.html" %}

{% block content %}
<style>
    .tierlist-container {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 30px;
        margin-top: 20px;
        max-width: 1400px;
        margin-left: auto;
        margin-right: auto;
    }

    .control-box {
        background: var(--bg-main);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border: 2px solid var(--border-color);
    }

    .control-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
    }

    .control-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .control-label {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 0.95rem;
    }

    .control-select {
        padding: 10px 15px;
        font-size: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        min-width: 200px;
        appearance: none;
        /* ê¸°ë³¸ í™”ì‚´í‘œ ì œê±° */
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        /* í™”ì‚´í‘œ ìœ„ì¹˜ ì¡°ì • */
        padding-right: 35px;
    }

    .load-btn {
        padding: 10px 30px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: auto;
    }

    .load-btn:hover {
        opacity: 0.9;
    }

    .chart-container {
        background: var(--bg-main);
        border-radius: 10px;
        padding: 30px;
        border: 2px solid var(--border-color);
        min-height: 1200px;
        /* 600px â†’ 800px */
    }

    .empty-state {
        text-align: center;
        padding: 100px 20px;
        color: var(--text-secondary);
    }

    .chart-legend {
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.85rem;
        padding: 10px;
    }

    @media (max-width: 768px) {
        .chart-legend {
            display: block;
        }

        .tierlist-container {
            padding: 20px 10px;
            margin-top: 10px;
        }

        .control-box {
            padding: 15px;
        }

        .control-group {
            flex-direction: row;
            gap: 10px;
            justify-content: center;
            /* ì™¼ìª½ ì •ë ¬ */
        }

        .control-select {
            flex: 1 1 auto;
            min-width: 140px;
            /* 170px â†’ 140px */
            max-width: 200px;
        }

        .load-btn {
            flex-shrink: 0;
            width: auto;
            padding: 10px 20px;
        }

        .chart-container {
            padding: 12px;
            min-height: 1300px;
        }
    }
</style>

<div class="tierlist-container">
    <!-- ì»¨íŠ¸ë¡¤ ì˜ì—­ -->
    <div class="control-box">
        <div class="control-group">
            <div class="control-item">
                <!--<label class="control-label">ìƒìœ„ ê¸°ì¤€</label>-->
                <select id="rankingSelect" class="control-select">
                    <option value="10000">ìƒìœ„ 10,000ëª…</option>
                    <option value="9000">ìƒìœ„ 9,000ëª…</option>
                    <option value="8000">ìƒìœ„ 8,000ëª…</option>
                    <option value="7000">ìƒìœ„ 7,000ëª…</option>
                    <option value="6000">ìƒìœ„ 6,000ëª…</option>
                    <option value="5000" selected>ìƒìœ„ 5,000ëª…</option>
                    <option value="4000">ìƒìœ„ 4,000ëª…</option>
                    <option value="3000">ìƒìœ„ 3,000ëª…</option>
                    <option value="2000">ìƒìœ„ 2,000ëª…</option>
                    <option value="1000">ìƒìœ„ 1,000ëª…</option>
                </select>
            </div>

            <button onclick="loadTierlist()" class="load-btn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
    </div>

    <!-- ì°¨íŠ¸ ì˜ì—­ -->
    <div class="chart-container" id="chartContainer">
        <div class="empty-state">
            <h3>ğŸ“ˆ íŒ€ì»¬ëŸ¬ ì‚¬ìš©ë¥  ì¶”ì´ë¥¼ í™•ì¸í•˜ì„¸ìš”!</h3>
            <p>ìƒìœ„ ê¸°ì¤€ì„ ì„ íƒí•œ í›„ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
        </div>
        <div class="chart-legend">xì¶•: ë‚ ì§œ | yì¶•: ìˆœìœ„</div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let currentChart = null;

    // íŒ€ ë¡œê³  ë§¤í•‘ (Flaskì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°)
    const teamLogos = {{ team_logos | tojson }};


    // í‹°ì–´ë¦¬ìŠ¤íŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadTierlist() {
        const ranking = document.getElementById('rankingSelect').value;
        const chartContainer = document.getElementById('chartContainer');

        // ë¡œë”© í‘œì‹œ
        chartContainer.innerHTML = `
        <div class="empty-state">
            <h3>ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h3>
        </div>
    `;

        try {
            // ìƒˆ API í˜¸ì¶œ
            const response = await fetch(`/api/get_all_tierlist_data?ranking=${ranking}`);
            const result = await response.json();

            if (!result.success) {
                chartContainer.innerHTML = `
                <div class="empty-state">
                    <h3>ğŸ˜¢ ${result.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'}</h3>
                </div>
            `;
                return;
            }

            // ì°¨íŠ¸ í‘œì‹œ
            displayChart(result.data, ranking);

        } catch (error) {
            console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            chartContainer.innerHTML = `
            <div class="empty-state">
                <h3>âŒ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h3>
            </div>
        `;
        }
    }

    // ì°¨íŠ¸ í‘œì‹œ
    async function displayChart(data, ranking) {
        const chartContainer = document.getElementById('chartContainer');

        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (currentChart) {
            currentChart.destroy();
        }

        // ìº”ë²„ìŠ¤ ìƒì„±
        chartContainer.innerHTML = '<canvas id="tierChart"></canvas>';
        const ctx = document.getElementById('tierChart').getContext('2d');

        // Xì¶• ë¼ë²¨ (ë‚ ì§œ)
        const dates = data.map(d => d.date);

        // ëª¨ë“  íŒ€ ì´ë¦„ ìˆ˜ì§‘
        const allTeams = new Set();
        data.forEach(d => {
            d.teams.forEach(t => allTeams.add(t.name));
        });

        // ë¡œê³  ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ
        const loadedLogos = {};
        await Promise.all(
            Array.from(allTeams).map(teamName => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        loadedLogos[teamName] = img;
                        resolve();
                    };
                    img.onerror = () => resolve(); // ë¡œë“œ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
                    img.src = teamLogos[teamName];
                });
            })
        );

        // ê° íŒ€ë³„ ë°ì´í„°ì…‹ ìƒì„±
        const datasets = [];
        let colorIndex = 0;

        allTeams.forEach(teamName => {
            const teamData = dates.map(date => {
                const dateData = data.find(d => d.date === date);
                const team = dateData.teams.find(t => t.name === teamName);
                return team ? team.rank : null;
            });

            datasets.push({
                label: teamName,
                data: teamData,
                borderColor: 'rgba(128, 128, 128, 0.4)',  // ê¸°ë³¸: ì—°í•œ íšŒìƒ‰
                hoverBorderColor: 'rgba(255, 255, 255, 0.95)',  // í˜¸ë²„: ë°ì€ í°ìƒ‰
                backgroundColor: 'transparent',
                borderWidth: 2,
                hoverBorderWidth: 3,  // í˜¸ë²„ ì‹œ ë‘ê»ê²Œ
                tension: 0.1,
                spanGaps: false,
                pointStyle: loadedLogos[teamName],
                pointRadius: 7,
                pointHoverRadius: 9
            });

            colorIndex++;
        });

        currentChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,  /* true â†’ false */
                interaction: {
                    mode: 'dataset',
                    intersect: false
                },
                onHover: (event, activeElements, chart) => {
                    if (activeElements.length > 0) {
                        const activeIndex = activeElements[0].datasetIndex;

                        // ëª¨ë“  dataset ì²˜ë¦¬
                        chart.data.datasets.forEach((dataset, index) => {
                            if (index === activeIndex) {
                                // hoverëœ ë¼ì¸: ë°ê²Œ
                                dataset.borderColor = 'rgba(255, 255, 255, 0.95)';
                                dataset.borderWidth = 3;
                            } else {
                                // ë‹¤ë¥¸ ë¼ì¸ë“¤: ìŒì˜ ì²˜ë¦¬
                                dataset.borderColor = 'rgba(128, 128, 128, 0.15)';
                                dataset.borderWidth = 2;
                            }
                        });
                    } else {
                        // hover í•´ì œ: ì›ë˜ëŒ€ë¡œ
                        chart.data.datasets.forEach(dataset => {
                            dataset.borderColor = 'rgba(128, 128, 128, 0.4)';
                            dataset.borderWidth = 2;
                        });
                    }
                    chart.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì—…ë°ì´íŠ¸
                },
                plugins: {
                    title: {
                        display: true,
                        text: `íŒ€ì»¬ëŸ¬ ì‚¬ìš©ë¥  ë³€í™” | ìƒìœ„ ${parseInt(ranking).toLocaleString()}ëª… ê¸°ì¤€`,
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                        font: {
                            size: window.innerWidth <= 768 ? 14 : 22,
                            weight: 'bold'
                        },
                        padding: {
                            bottom: 5  // 20 â†’ 5ë¡œ ì¤„ì„
                        }
                    },
                    subtitle: {
                        display: true,
                        text: '(xì¶•: ë‚ ì§œ, yì¶•: ìˆœìœ„)',
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                        font: {
                            size: window.innerWidth <= 768 ? 11 : 14,  // ì‘ì€ í¬ê¸°
                            weight: 'normal'
                        },
                        padding: {
                            bottom: 20
                        }
                    },
                    legend: {
                        display: false  /* ë²”ë¡€ ì™„ì „ ì œê±° */
                    },
                    tooltip: {
                        mode: 'nearest',
                        displayColors: false,
                        titleFont: {
                            size: window.innerWidth <= 768 ? 14 : 18  // ëª¨ë°”ì¼ 14px
                        },
                        bodyFont: {
                            size: window.innerWidth <= 768 ? 12 : 16  // ëª¨ë°”ì¼ 12px
                        },
                        padding: window.innerWidth <= 768 ? 10 : 15,  // ëª¨ë°”ì¼ 10px
                        boxPadding: window.innerWidth <= 768 ? 5 : 8,  // ëª¨ë°”ì¼ 5px
                        yAlign: 'top',
                        xAlign: 'top',
                        callbacks: {
                            title: function (context) {
                                if (context && context.length > 0) {
                                    return context[0].dataset.label;
                                }
                                return '';
                            },
                            label: function (context) {
                                if (context && context.dataset && context.dataset.data) {
                                    const ranks = context.dataset.data.map(v => v !== null ? v : 'N').join(' - ');
                                    return ranks;
                                }
                                return '';
                            },
                            afterLabel: function (context) {
                                if (context && context.dataset && context.dataset.data) {
                                    const data = context.dataset.data;

                                    // Nì´ í•˜ë‚˜ë¼ë„ ìˆëŠ”ì§€ í™•ì¸
                                    const hasN = data.some(v => v === null);

                                    if (hasN) {
                                        return 'í‰ê·  : DC';
                                    } else {
                                        // í‰ê·  ê³„ì‚°
                                        const validRanks = data.filter(v => v !== null);
                                        const average = validRanks.reduce((sum, v) => sum + v, 0) / validRanks.length;
                                        return `í‰ê·  : ${average.toFixed(1)}ìœ„`;
                                    }
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        reverse: true,  // 1ìœ„ê°€ ìœ„, 20ìœ„ê°€ ì•„ë˜
                        min: 0,
                        max: 31,
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                            callback: function (value) {
                                // 1~30ë§Œ í‘œì‹œ
                                return (value >= 1 && value <= 30 && Number.isInteger(value)) ? value : '';
                            }
                        },
                        grid: {
                            color: 'rgba(128, 128, 128, 0.1)'
                        },
                        title: {
                            display: false,  // ì™„ì „íˆ ì œê±°
                            text: 'ìˆœìœ„',
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                        }
                    },
                    x: {
                        offset: true,
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary')
                        },
                        grid: {
                            color: 'rgba(128, 128, 128, 0.1)'
                        },
                        title: {
                            display: false,  // ì™„ì „íˆ ì œê±°
                            text: 'ë‚ ì§œ',
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                        }
                    }
                }
            }
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ 5000ëª… ê¸°ì¤€ ì°¨íŠ¸ í‘œì‹œ
    window.addEventListener('DOMContentLoaded', function () {
        loadTierlist();
    });
</script>

{% endblock %}