{% extends "index.html" %}

{% block content %}
<div class="container" style="max-width: 1000px; margin: 40px auto; padding: 0 20px;">

    <!-- ê²Œì‹œê¸€ ìƒì„¸ -->
    <div style="background: var(--card-bg); border-radius: 12px; padding: 40px; margin-bottom: 30px;">

        <!-- ì¹´í…Œê³ ë¦¬ + ì œëª© -->
        <div style="margin-bottom: 20px;">
            <span class="badge"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 14px; border-radius: 12px; font-size: 0.9rem; margin-bottom: 15px; display: inline-block;">
                {{ post.category }}
            </span>
            <h2 style="color: var(--text-primary); font-weight: 700; margin: 0;">{{ post.title }}</h2>
        </div>

        <!-- ì‘ì„±ì ì •ë³´ -->
        <div
            style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 2px solid var(--border-color); margin-bottom: 30px;">
            <div style="display: flex; gap: 20px; color: var(--text-secondary); font-size: 0.95rem;">
                <span><strong style="color: var(--text-primary);">{{ post.author }}</strong> <span
                        style="color: var(--text-muted); font-size: 0.9em;">{{ post.ip_display }}</span></span>
                <span>{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                <span>ì¡°íšŒ {{ post.views }}</span>
                <span>ì¶”ì²œ {{ post.likes }}</span>
            </div>

            <!-- ë²„íŠ¼ ê·¸ë£¹ -->
            <div style="display: flex; gap: 10px;">
                <!-- ê³µìœ  ë²„íŠ¼ -->
                <button onclick="sharePost()" class="btn btn-outline-secondary"
                    style="padding: 6px 20px; border-radius: 20px;">
                    ğŸ“¤ ê³µìœ 
                </button>

                <!-- ìˆ˜ì • ë²„íŠ¼ -->
                <button onclick="editPost({{ post.id }})" class="btn btn-outline-primary"
                    style="padding: 6px 20px; border-radius: 20px;">
                    âœï¸ ìˆ˜ì •
                </button>

                <!-- ì‚­ì œ ë²„íŠ¼ -->
                <button onclick="deletePost({{ post.id }})" class="btn btn-outline-danger"
                    style="padding: 6px 20px; border-radius: 20px;">
                    ğŸ—‘ï¸ ì‚­ì œ
                </button>
            </div>
        </div>

        <!-- ë³¸ë¬¸ ë‚´ìš© -->
        <div class="post-content"
            style="color: var(--text-primary); line-height: 1.8; font-size: 1.05rem; min-height: 200px; margin-bottom: 30px;">
            {{ post.content | safe }}
        </div>

        <!-- ì¶”ì²œ/ë¹„ì¶”ì²œ ë²„íŠ¼ -->
        <div
            style="text-align: center; padding: 30px 0; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; gap: 20px; justify-content: center; align-items: center;">
                <button onclick="votePost({{ post.id }}, 'like')" id="likeBtn" class="btn btn-primary"
                    style="padding: 12px 40px; font-size: 1.1rem; border-radius: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    ğŸ‘ ì¶”ì²œ (<span id="likeCount">{{ post.likes }}</span>)
                </button>

                <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary);">
                    ìˆœì¶”ì²œ: <span id="netVotes">{{ post.likes - (post.dislikes or 0) }}</span>
                </div>

                <button onclick="votePost({{ post.id }}, 'dislike')" id="dislikeBtn" class="btn btn-secondary"
                    style="padding: 12px 40px; font-size: 1.1rem; border-radius: 25px; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); border: none;">
                    ğŸ‘ ë¹„ì¶”ì²œ (<span id="dislikeCount">{{ post.dislikes or 0 }}</span>)
                </button>
            </div>
        </div>

    </div>

    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
    <div style="background: var(--card-bg); border-radius: 12px; padding: 30px;">

        <h4 style="color: var(--text-primary); margin-bottom: 20px; font-weight: 600;">
            ğŸ’¬ ëŒ“ê¸€ <span style="color: var(--text-secondary); font-size: 0.9rem;">({{ comments|length }})</span>
        </h4>

        <!-- ëŒ“ê¸€ ëª©ë¡ -->
        {% if comments %}
        <div style="margin-bottom: 30px;">
            {% for comment in comments %}
            <div
                style="padding: 20px; border-bottom: 1px solid var(--border-color); {% if loop.last %}border-bottom: none;{% endif %}">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <strong style="color: var(--text-primary);">{{ comment.author }}</strong>
                        <span style="color: var(--text-muted); font-size: 0.85em;">{{ comment.ip_display }}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">
                            {{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </span>
                        <button onclick="deleteComment({{ comment.id }})" class="btn btn-sm btn-outline-danger"
                            style="padding: 2px 10px; font-size: 0.8rem;">
                            ì‚­ì œ
                        </button>
                    </div>
                </div>
                <div style="color: var(--text-primary); line-height: 1.6;">
                    {{ comment.content }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div
            style="text-align: center; padding: 40px 20px; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); margin-bottom: 30px;">
            ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!
        </div>
        {% endif %}

        <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
        <form method="POST" action="/community/comment/{{ post.id }}" style="margin-top: 30px;">

            <!-- ì‘ì„±ì ì…ë ¥ -->
            <div class="mb-3">
                <input type="text" name="author" value="ìµëª…" required maxlength="100" placeholder="ì‘ì„±ì"
                    class="form-control"
                    style="background: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px; border-radius: 8px; max-width: 200px;">
            </div>

            <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
            <div class="mb-3">
                <input type="password" name="password" required maxlength="50" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì‚­ì œ ì‹œ í•„ìš”)"
                    class="form-control"
                    style="background: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px; border-radius: 8px; max-width: 200px;">
            </div>

            <!-- ëŒ“ê¸€ ë‚´ìš© -->
            <div class="mb-3">
                <textarea name="content" required rows="4" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš” (ë¡œê·¸ì¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?)" class="form-control"
                    style="background: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 15px; border-radius: 8px; resize: vertical;"></textarea>
            </div>

            <!-- ì œì¶œ ë²„íŠ¼ -->
            <div style="text-align: right;">
                <button type="submit" class="btn btn-success" style="padding: 10px 30px; font-weight: 600;">
                    ëŒ“ê¸€ ì‘ì„±
                </button>
            </div>

        </form>

    </div>

</div>


<!-- ê²Œì‹œê¸€ ëª©ë¡ ì„¹ì…˜ ì¶”ê°€ -->
<div class="container" style="max-width: 1400px; margin: 40px auto 0; padding: 0 20px;">

    <h4 style="color: var(--text-primary); margin-bottom: 20px; font-weight: 600;">
        ğŸ“‹ {{ post.category }} ê²Œì‹œê¸€
    </h4>

    <div class="table-responsive" style="background: var(--card-bg); border-radius: 12px; overflow: hidden;">
        <table class="table table-hover" style="margin: 0; color: var(--text-primary);">
            <thead style="background: var(--secondary-bg); border-bottom: 2px solid var(--border-color);">
                <tr>
                    <th style="width: 80px; text-align: center; padding: 15px 10px;">ë²ˆí˜¸</th>
                    <th style="width: 80px; text-align: center; padding: 15px 10px;">íƒ­</th>
                    <th style="padding: 15px 20px;">ì œëª©</th>
                    <th style="width: 150px; text-align: center; padding: 15px 10px;">ê¸€ì“´ì´</th>
                    <th style="width: 120px; text-align: center; padding: 15px 10px;">ë‚ ì§œ</th>
                    <th style="width: 80px; text-align: center; padding: 15px 10px;">ì¡°íšŒ</th>
                    <th style="width: 80px; text-align: center; padding: 15px 10px;">ì¶”ì²œ</th>
                </tr>
            </thead>
            <tbody>
                {% for p in related_posts %}
                <tr style="cursor: pointer; border-bottom: 1px solid var(--border-color); {% if p.id == post.id %}background: var(--hover-bg);{% endif %}"
                    onclick="window.location='/community/post/{{ p.id }}?category={{ current_category }}'">
                    <td style="text-align: center; padding: 12px 10px; color: var(--text-secondary); font-weight: 500;">
                        {{ p.id }}
                    </td>
                    <td
                        style="text-align: center; padding: 12px 10px; color: var(--text-primary); font-size: 0.9rem; white-space: nowrap;">
                        {{ p.category }}
                    </td>
                    <td style="padding: 12px 20px;">
                        <strong style="color: var(--text-primary); font-size: 1rem;">
                            {{ p.title }}
                            {% if p.has_image %}
                            <span style="margin-left: 6px; font-size: 0.9rem;">ğŸ–¼ï¸</span>
                            {% endif %}
                            {% if p.has_video %}
                            <span
                                style="margin-left: {% if p.has_image %}-5px{% else %}2px{% endif %}; font-size: 0.9rem;">â–¶ï¸</span>
                            {% endif %}
                        </strong>
                    </td>
                    <td style="text-align: center; padding: 12px 10px; color: var(--text-secondary);">
                        {{ p.author }} <span style="color: var(--text-muted); font-size: 0.85em;">{{ p.ip_display
                            }}</span>
                    </td>
                    <td
                        style="text-align: center; padding: 12px 10px; color: var(--text-secondary); font-size: 0.9rem;">
                        {{ p.display_date }}
                    </td>
                    <td style="text-align: center; padding: 12px 10px; color: var(--text-secondary);">
                        {{ p.views }}
                    </td>
                    <td style="text-align: center; padding: 12px 10px; color: var(--text-secondary);">
                        {{ p.likes }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    {% if total_pages > 1 %}
    <nav style="margin-top: 30px;">
        <ul class="pagination justify-content-center">
            {% if current_page > 1 %}
            <li class="page-item">
                <a class="page-link"
                    href="/community?category={{ current_category }}&page={{ current_page - 1 }}">ì´ì „</a>
            </li>
            {% endif %}

            {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if p == current_page %}active{% endif %}">
                <a class="page-link" href="/community?category={{ current_category }}&page={{ p }}">{{ p }}</a>
            </li>
            {% endfor %}

            {% if current_page < total_pages %} <li class="page-item">
                <a class="page-link"
                    href="/community?category={{ current_category }}&page={{ current_page + 1 }}">ë‹¤ìŒ</a>
                </li>
                {% endif %}
        </ul>
    </nav>
    {% endif %}

</div>


<!-- ê²€ìƒ‰ ì˜ì—­ -->
<div class="container" style="max-width: 1400px; margin: 30px auto 0; padding: 0 20px;">
    <div style="display: flex; gap: 10px; align-items: center; max-width: 600px; margin: 0 auto;">
        <select name="search_type" id="searchType" class="form-select"
            style="width: 140px; background: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px; border-radius: 8px;">
            <option value="title_content">ì œëª©+ë‚´ìš©</option>
            <option value="title">ì œëª©</option>
            <option value="content">ë‚´ìš©</option>
            <option value="author">ê¸€ì“´ì´</option>
            <option value="comment">ëŒ“ê¸€</option>
        </select>

        <input type="text" id="searchKeyword" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            style="flex: 1; background: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 12px; border-radius: 8px;">

        <button onclick="searchPosts()" class="btn btn-primary" style="padding: 8px 20px; white-space: nowrap;">
            ğŸ” ê²€ìƒ‰
        </button>
    </div>
</div>


<script>
    function sharePost() {
        // í˜„ì¬ í˜ì´ì§€ URL ë³µì‚¬
        const url = window.location.href;

        // í´ë¦½ë³´ë“œì— ë³µì‚¬
        navigator.clipboard.writeText(url).then(() => {
            alert('ê²Œì‹œê¸€ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n' + url);
        }).catch(err => {
            // ë³µì‚¬ ì‹¤íŒ¨ ì‹œ fallback
            prompt('ì´ ì£¼ì†Œë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', url);
        });
    }

    function searchPosts() {
        const searchType = document.getElementById('searchType').value;
        const keyword = document.getElementById('searchKeyword').value.trim();

        if (!keyword) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        window.location.href = `/community?search_type=${searchType}&keyword=${encodeURIComponent(keyword)}`;
    }

    function votePost(postId, voteType) {
        fetch(`/community/vote/${postId}/${voteType}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                    document.getElementById('likeCount').textContent = data.likes;
                    document.getElementById('dislikeCount').textContent = data.dislikes;
                    document.getElementById('netVotes').textContent = data.net_votes;

                    // ë²„íŠ¼ ë¹„í™œì„±í™”
                    document.getElementById('likeBtn').disabled = true;
                    document.getElementById('dislikeBtn').disabled = true;

                    alert(voteType === 'like' ? 'ì¶”ì²œí–ˆìŠµë‹ˆë‹¤!' : 'ë¹„ì¶”ì²œí–ˆìŠµë‹ˆë‹¤!');
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
            });
    }

    function deletePost(postId) {
        const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (!password) return;

        fetch(`/community/post/${postId}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `password=${encodeURIComponent(password)}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = '/community';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                console.error(error);
            });
    }

    function editPost(postId) {
        const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (!password) return;

        // ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
        window.location.href = `/community/post/${postId}/edit?password=${encodeURIComponent(password)}`;
    }

    function deleteComment(commentId) {
        const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (!password) return;

        fetch(`/community/comment/${commentId}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `password=${encodeURIComponent(password)}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                console.error(error);
            });
    }

    // ì—”í„°í‚¤ ê²€ìƒ‰
    document.getElementById('searchKeyword').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            searchPosts();
        }
    });
</script>


<style>
    /* ë³¸ë¬¸ ë‚´ìš© ìŠ¤íƒ€ì¼ */
    .post-content {
        display: block !important;
        color: var(--text-primary) !important;
        line-height: 1.8 !important;
        font-size: 1.05rem !important;
        word-wrap: break-word !important;
    }

    .post-content .ql-cursor,
    .post-content .ql-clipboard {
        display: none !important;
    }

    .post-content strong,
    .post-content b {
        font-weight: 700 !important;
    }

    .post-content em,
    .post-content i {
        font-style: italic !important;
    }

    .post-content u {
        text-decoration: underline !important;
    }

    .post-content s,
    .post-content del {
        text-decoration: line-through !important;
    }

    .post-content h1 {
        font-size: 2rem !important;
        font-weight: 700 !important;
        margin: 20px 0 10px !important;
    }

    .post-content h2 {
        font-size: 1.5rem !important;
        font-weight: 700 !important;
        margin: 20px 0 10px !important;
    }

    .post-content h3 {
        font-size: 1.25rem !important;
        font-weight: 700 !important;
        margin: 20px 0 10px !important;
    }

    .post-content ul,
    .post-content ol {
        margin-left: 25px !important;
    }

    .post-content p {
        margin: 10px 0 !important;
    }

    .post-content img {
        max-width: 100% !important;
        height: auto !important;
        margin: 15px 0 !important;
    }

    .post-content a {
        color: #667eea !important;
        text-decoration: underline !important;
    }

    .btn-outline-secondary {
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
    }

    .btn-outline-secondary:hover {
        background: var(--hover-bg);
        color: var(--text-primary);
    }

    /* ì˜ìƒ(iframe) ë°˜ì‘í˜• ì»¨í…Œì´ë„ˆ */
    .post-content iframe {
        max-width: 100% !important;
        width: 100% !important;
        aspect-ratio: 16 / 9 !important;
        /* 16:9 ë¹„ìœ¨ ìœ ì§€ */
        height: auto !important;
        border-radius: 8px !important;
        margin: 20px 0 !important;
    }

    /* êµ¬í˜• ë¸Œë¼ìš°ì € ëŒ€ì‘ (aspect-ratio ë¯¸ì§€ì› ì‹œ) */
    @supports not (aspect-ratio: 16 / 9) {
        .post-content iframe {
            height: 450px !important;
        }
    }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 768px) {
        @supports not (aspect-ratio: 16 / 9) {
            .post-content iframe {
                height: 300px !important;
            }
        }
    }

    /* ê²€ìƒ‰ íƒ€ì… ë“œë¡­ë‹¤ìš´ ë‹¤í¬ëª¨ë“œ ëŒ€ì‘ */
    [data-theme="dark"] .form-select option {
        background: #2d3748;
        color: #ffffff;
    }
</style>
{% endblock %}